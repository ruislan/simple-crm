<!-- 数据爬取管理 -->
{% extends 'layouts/default.html' %}
{% set title = '联系类别' %}
{% set menuActive = 'system' %}
{% block container %}
<div class="h4 mb-4">系统 - 联系类别</div>
<div class="d-flex align-items-center justify-content-between flex-wrap">
    <div class="d-flex align-items-center">
        <div><input class="form-control" type="search" id="searchName" placeholder="名称" /></div>
        <div class="ms-1"><button id="searchBtn" class="btn btn-dark" onclick="app.search()">搜索</button></div>
    </div>
    <div class="d-flex align-items-center">
        <div class="ms-3 d-flex align-items-center flex-wrap">
            <button id="toolbarNew"
                class="btn btn-dark btn-action ms-1 d-flex justify-content-center align-items-center"
                onclick="app.new()" data-toggle="tooltip" title="新增类别">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-plus-lg"
                    viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
                </svg>
            </button>
        </div>
        <div class="ms-3 d-flex align-items-center flex-wrap">
            <button id="toolbarRefresh" onclick="app.search()" data-toggle="tooltip" title="刷新"
                class="btn btn-dark btn-action ms-1 d-flex justify-content-center align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-arrow-clockwise" width="24"
                    height="24" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                    <path
                        d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
                </svg>
            </button>
        </div>
    </div>
</div>
<div class="d-flex flex-column mt-3">
    <div id="spinner" class="text-center" style="display: none;">
        <div class="spinner-border" role="status"></div>
    </div>
    <div id="table" class="table-responsive"></div>
</div>
{% endblock container %}
{% block script %}
<script src="/public/js/links.js"></script>
<script>
    const app = {
        data: {
        },
        search() {
            $('#searchBtn').attr('disabled', true);
            $('#spinner').show();
            const data = { name: $('#searchName').val() };
            $.ajax({
                type: 'get',
                url: '/system/link-types/search',
                data,
            }).done(function (result) {
                app.data.tableData = result.data;
                app.renderTable();
            }).always(function () {
                $('#searchBtn').attr('disabled', false);
                $('#spinner').hide();
            });
        },
        renderTable() {
            // clear dom
            const table = document.getElementById('table');
            while (table.firstChild) table.removeChild(table.firstChild);

            // render
            let rows = '';
            for (let i = 0; i < this.data.tableData.length; i++) {
                const item = this.data.tableData[i];
                rows += `
                    <tr id="row-${item.id}">
                        <th scope="row">${item.id}</th>
                        <td>${item.name}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-sm btn-dark" onclick="app.edit(${i})">编辑</button>
                                ${item.deletable ? `<button type="button" class="btn btn-sm btn-danger ms-1" onclick="app.delete(${item.id})">删除</button>` : ''}
                            </div>
                        </td>
                    </tr>            
                `;
            }
            const tableHTML = `
                <table class="table table-bordered table-group-divider table-light">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">名称</th>
                            <th scope="col">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
            table.innerHTML = tableHTML;
        },
        new() {
            linkTypeEditor.open({
                title: '新建',
                onDone: () => helper.toast('操作成功', 'success'),
                onAlways: () => app.search()
            });
        },
        edit(idx) {
            const item = this.data.tableData[idx];
            linkTypeEditor.open({
                title: '新建',
                data: item,
                onDone: () => helper.toast('操作成功', 'success'),
                onAlways: () => app.search()
            });
        },
        delete(id) {
            helper.confirm('删除这个类型，将会同时删除这个类型下所有的联络信息！这是一个不可逆操作！请确保这个类型下没有任何联络信息！', function () {
                $.ajax({
                    url: `/system/link-types/${id}`,
                    type: 'delete'
                }).done(function () {
                    helper.toast('操作成功', 'success');
                    app.search();
                }).fail(function () {
                    helper.toast('操作失败，请刷新重试，或者联系管理员。', 'danger');
                });
            });
        }
    };

    $(async function () {
        app.search();
    });
</script>
{% endblock script %}